'''
Created on 29/11/2012

@author: victor
'''
import unittest
import numpy
from pyRMSD.utils.proteinReading import flattenCoords, Reader

class Test(unittest.TestCase):
    
    @classmethod
    def setUpClass(self):
        self.mini_CA_coords = [38.967 , 49.052 , 29.293 , 41.557 , 51.682 , 28.303 , 42.387 , 53.162 , 24.933 , 45.577 , 53.462 , 
                            22.833 , 45.937 , 56.082 , 20.063 , 48.407 , 55.882 , 17.143 , 50.227 , 58.882 , 15.463 , 48.077 , 
                            58.092 , 12.373 , 44.747 , 58.902 , 14.123 , 40.256 , 44.7 , 30.122 , 42.036 , 47.77 , 28.672 , 
                            42.286 , 49.22 , 25.152 , 45.286 , 50.33 , 23.102 , 44.846 , 52.27 , 19.902 , 47.386 , 52.3 , 17.012 , 
                            48.066 , 55.58 , 15.222 , 46.236 , 54.16 , 12.152 , 43.006 , 53.7 , 14.022 , 41.872 , 43.958 , 30.145 , 
                            43.272 , 47.208 , 28.825 , 43.142 , 49.178 , 25.555 , 45.942 , 50.878 , 23.545 , 45.132 , 53.448 , 
                            20.795 , 47.732 , 53.668 , 17.945 , 48.792 , 56.978 , 16.285 , 46.222 , 56.528 , 13.445 , 43.532 , 
                            56.148 , 16.185] 

        self.mini_all_coords = [38.547 , 48.562 , 30.593 , 37.847 , 49.102 , 31.063 , 38.967 , 49.052 , 29.293 , 39.497 , 48.202 , 
                                28.853 , 37.777 , 49.322 , 28.373 , 38.127 , 49.892 , 27.513 , 36.997 , 49.952 , 28.813 , 37.227 , 
                                47.982 , 27.903 , 37.977 , 47.422 , 27.333 , 36.467 , 48.132 , 27.133 , 36.477 , 47.092 , 28.883 , 
                                36.677 , 45.892 , 29.043 , 35.607 , 47.662 , 29.723 , 35.417 , 48.652 , 29.753 , 35.357 , 47.032 , 
                                30.473 , 39.807 , 50.302 , 29.453 , 39.547 , 51.182 , 30.263 , 40.787 , 50.482 , 28.553 , 41.007 , 
                                49.652 , 28.023 , 41.557 , 51.682 , 28.303 , 40.957 , 52.522 , 28.653 , 42.937 , 51.722 , 28.953 , 
                                43.467 , 52.652 , 28.753 , 42.627 , 51.862 , 30.443 , 43.467 , 52.342 , 30.943 , 41.747 , 52.502 , 
                                30.553 , 42.477 , 50.882 , 30.883 , 43.927 , 50.632 , 28.533 , 44.187 , 50.662 , 27.483 , 43.597 , 
                                49.612 , 28.743 , 45.287 , 50.882 , 29.173 , 46.037 , 50.172 , 28.823 , 45.647 , 51.842 , 28.783 , 
                                45.337 , 50.982 , 30.253 , 41.817 , 51.822 , 26.813 , 41.817 , 50.782 , 26.153 , 42.087 , 53.042 , 
                                26.343 , 42.107 , 53.772 , 27.043 , 42.387 , 53.162 , 24.933 , 42.167 , 52.242 , 24.393 , 41.567 , 
                                54.282 , 24.323 , 41.967 , 54.402 , 23.313 , 41.947 , 55.192 , 24.783 , 40.067 , 54.132 , 24.463 , 
                                39.347 , 54.902 , 25.383 , 39.817 , 55.772 , 25.823 , 37.977 , 54.692 , 25.613 , 37.467 , 55.172 , 
                                26.433 , 37.457 , 53.532 , 25.033 , 36.387 , 53.402 , 25.113 , 38.097 , 52.892 , 23.963 , 37.557 , 
                                52.142 , 23.403 , 39.477 , 53.062 , 23.793 , 40.017 , 52.482 , 23.053 , 43.877 , 53.382 , 24.703 , 
                                44.617 , 53.862 , 25.553 , 44.327 , 53.102 , 23.483 , 43.677 , 52.582 , 22.903 , 45.577 , 53.462 , 
                                22.833 , 46.027 , 54.242 , 23.453 , 46.507 , 52.282 , 22.613 , 45.907 , 51.492 , 22.153 , 47.727 , 
                                52.582 , 21.743 , 48.277 , 51.652 , 21.633 , 47.407 , 52.922 , 20.753 , 48.217 , 53.462 , 22.163 , 
                                47.087 , 51.802 , 23.943 , 46.357 , 51.452 , 24.673 , 47.647 , 50.872 , 23.793 , 47.677 , 52.632 , 
                                24.313 , 45.297 , 54.132 , 21.493 , 44.497 , 53.732 , 20.653 , 46.017 , 55.222 , 21.223 , 46.697 , 
                                55.472 , 21.933 , 45.937 , 56.082 , 20.063 , 45.207 , 55.632 , 19.383 , 45.247 , 57.362 , 20.523 ,
                                45.987 , 57.982 , 21.023 , 44.437 , 57.072 , 21.183 , 44.697 , 58.022 , 19.263 , 44.087 , 57.352 , 
                                18.663 , 45.547 , 58.382 , 18.693 , 43.787 , 59.172 , 19.693 , 43.047 , 58.772 , 20.393 , 43.357 , 
                                59.482 , 18.743 , 44.447 , 60.282 , 20.513 , 45.257 , 60.632 , 19.873 , 44.867 , 59.922 , 21.453 , 
                                43.577 , 61.432 , 20.763 , 43.837 , 61.862 , 21.643 , 43.687 , 62.052 , 19.973 , 42.607 , 61.132 , 
                                20.843 , 47.267 , 56.232 , 19.343 , 48.227 , 56.702 , 19.953 , 47.277 , 55.892 , 18.053 , 46.387 , 
                                55.542 , 17.753 , 48.407 , 55.882 , 17.143 , 49.207 , 55.452 , 17.753 , 48.177 , 55.042 , 15.883 , 
                                48.977 , 55.162 , 15.153 , 47.907 , 53.582 , 16.243 , 48.587 , 53.142 , 16.983 , 46.887 , 53.472 , 
                                16.613 , 48.017 , 52.882 , 15.423 , 47.007 , 55.422 , 15.203 , 47.037 , 55.142 , 14.283 , 48.737 , 
                                57.242 , 16.563 , 47.887 , 58.102 , 16.323 , 49.947 , 57.622 , 16.123 , 50.667 , 56.932 , 15.983 , 
                                50.227 , 58.882 , 15.463 , 49.717 , 59.582 , 16.123 , 51.717 , 59.142 , 15.633 , 52.227 , 58.632 , 
                                14.813 , 52.037 , 58.712 , 16.573 , 52.097 , 60.622 , 15.703 , 51.547 , 61.212 , 14.973 , 51.787 , 
                                61.282 , 17.043 , 52.107 , 62.322 , 17.153 , 50.747 , 61.102 , 17.293 , 52.517 , 60.832 , 17.713 , 
                                53.537 , 60.892 , 15.303 , 54.247 , 60.482 , 16.023 , 53.827 , 60.492 , 14.333 , 53.637 , 61.982 , 
                                15.333 , 49.607 , 58.942 , 14.073 , 49.907 , 59.872 , 13.333 , 48.737 , 58.022 , 13.663 , 48.447 , 
                                57.262 , 14.273 , 48.077 , 58.092 , 12.373 , 48.507 , 58.842 , 11.713 , 48.167 , 56.712 , 11.713 , 
                                47.517 , 56.722 , 10.843 , 49.527 , 56.232 , 11.213 , 49.397 , 55.382 , 10.543 , 49.937 , 57.072 , 
                                10.653 , 50.137 , 56.052 , 12.093 , 47.727 , 55.672 , 12.553 , 47.377 , 54.922 , 12.053 , 46.607 , 
                                58.422 , 12.583 , 45.837 , 58.302 , 11.633 , 46.127 , 58.572 , 13.823 , 46.867 , 58.782 , 14.463 , 
                                44.747 , 58.902 , 14.123 , 44.357 , 59.492 , 13.293 , 44.817 , 59.522 , 15.013 , 43.827 , 57.702 , 
                                14.293 , 42.657 , 57.952 , 14.023 , 40.026 , 44.36 , 31.512 , 39.116 , 44.55 , 31.902 , 40.256 , 
                                44.7 , 30.122 , 41.126 , 44.11 , 29.822 , 39.046 , 44.37 , 29.252 , 39.206 , 44.87 , 28.302 , 
                                38.116 , 44.75 , 29.692 , 38.926 , 42.89 , 28.902 , 39.786 , 42.39 , 28.472 , 38.136 , 42.77 , 
                                28.152 , 38.426 , 42.21 , 30.162 , 39.126 , 41.44 , 30.822 , 37.186 , 42.44 , 30.582 , 36.606 , 
                                43.22 , 30.292 , 36.716 , 41.93 , 31.322 , 40.736 , 46.13 , 29.982 , 40.096 , 47.01 , 30.542 , 
                                41.726 , 46.43 , 29.122 , 42.196 , 45.62 , 28.752 , 42.036 , 47.77 , 28.672 , 41.106 , 48.29 , 
                                28.902 , 43.066 , 48.6 , 29.442 , 43.056 , 49.6 , 29.012 , 42.706 , 48.78 , 30.922 , 41.746 , 
                                49.3 , 30.922 , 42.566 , 47.82 , 31.412 , 43.426 , 49.45 , 31.392 , 44.446 , 47.97 , 29.272 , 
                                44.786 , 47.97 , 28.232 , 44.576 , 46.95 , 29.622 , 45.516 , 48.86 , 29.902 , 45.586 , 48.76 , 
                                30.982 , 46.456 , 48.61 , 29.422 , 45.236 , 49.91 , 29.752 , 42.316 , 47.87 , 27.182 , 42.606 , 
                                46.85 , 26.562 , 42.226 , 49.07 , 26.592 , 42.046 , 49.85 , 27.192 , 42.286 , 49.22 , 25.152 , 
                                42.386 , 48.23 , 24.712 , 40.996 , 49.74 , 24.532 , 40.946 , 49.48 , 23.472 , 40.996 , 50.83 , 
                                24.522 , 39.706 , 49.27 , 25.162 , 38.766 , 50.2 , 25.632 , 39.046 , 51.23 , 25.442 , 37.546 , 
                                49.75 , 26.152 , 36.756 , 50.45 , 26.372 , 37.316 , 48.38 , 26.322 , 36.396 , 48.02 , 26.752 , 
                                38.246 , 47.43 , 25.882 , 38.026 , 46.38 , 26.002 , 39.466 , 47.91 , 25.382 , 40.236 , 47.21 , 
                                25.112 , 43.496 , 50.07 , 24.762 , 43.926 , 51.07 , 25.342 , 44.086 , 49.71 , 23.622 , 43.786 , 
                                48.9 , 23.092 , 45.286 , 50.33 , 23.102 , 45.416 , 51.32 , 23.542 , 46.546 , 49.53 , 23.412 ,
                                46.456 , 48.49 , 23.102 , 47.836 , 50.1 , 22.822 , 48.676 , 49.55 , 23.262 , 47.816 , 49.9 , 
                                21.752 , 47.966 , 51.15 , 23.082 , 46.736 , 49.37 , 24.922 , 46.056 , 48.61 , 25.302 , 47.756 , 
                                49.18 , 25.252 , 46.456 , 50.32 , 25.372 , 45.086 , 50.55 , 21.612 , 44.746 , 49.61 , 20.902 , 
                                45.186 , 51.83 , 21.242 , 45.316 , 52.55 , 21.942 , 44.846 , 52.27 , 19.902 , 44.366 , 51.49 , 
                                19.312 , 43.806 , 53.38 , 19.932 , 44.186 , 54.29 , 20.392 , 42.956 , 53.07 , 20.542 , 43.286 , 
                                53.69 , 18.532 , 42.936 , 52.77 , 18.062 , 43.966 , 54.08 , 17.782 , 42.066 , 54.6 , 18.612 , 
                                41.276 , 54.12 , 19.182 , 41.606 , 54.82 , 17.652 , 42.326 , 55.96 , 19.272 , 42.806 , 55.86 , 
                                20.242 , 41.336 , 56.33 , 19.522 , 43.076 , 56.83 , 18.352 , 43.076 , 57.81 , 18.602 , 44.066 , 
                                56.63 , 18.262 , 42.666 , 56.8 , 17.432 , 46.136 , 52.66 , 19.192 , 46.766 , 53.61 , 19.652 , 
                                46.416 , 52.03 , 18.042 , 45.566 , 51.53 , 17.842 , 47.386 , 52.3 , 17.012 , 48.416 , 52.39 , 
                                17.382 , 47.296 , 51.22 , 15.942 , 48.056 , 51.3 , 15.162 , 47.316 , 49.74 , 16.332 , 46.916 , 
                                49.03 , 15.612 , 48.266 , 49.25 , 16.522 , 46.776 , 49.57 , 17.262 , 46.116 , 51.44 , 15.192 , 
                                45.456 , 51.38 , 15.892 , 47.136 , 53.67 , 16.402 , 46.006 , 54.13 , 16.282 , 48.206 , 54.33 , 
                                15.942 , 49.146 , 54.02 , 16.092 , 48.066 , 55.58 , 15.222 , 47.466 , 56.18 , 15.912 , 49.466 , 
                                56.18 , 15.182 , 49.996 , 55.54 , 14.482 , 49.956 , 56.09 , 16.152 , 49.526 , 57.63 , 14.722 , 
                                49.166 , 57.75 , 13.702 , 48.746 , 58.66 , 15.532 , 48.966 , 58.45 , 16.582 , 48.946 , 59.72 , 
                                15.332 , 47.706 , 58.35 , 15.432 , 50.996 , 58.04 , 14.772 , 51.376 , 57.75 , 15.752 , 51.506 , 
                                57.5 , 13.972 , 51.186 , 59.08 , 14.522 , 47.296 , 55.56 , 13.912 , 46.856 , 56.62 , 13.482 , 
                                47.076 , 54.39 , 13.302 , 47.506 , 53.57 , 13.712 , 46.236 , 54.16 , 12.152 , 46.146 , 55.11 , 
                                11.612 , 46.756 , 53.22 , 11.072 , 46.116 , 53.11 , 10.192 , 47.986 , 53.83 , 10.402 , 48.426 , 
                                53.13 , 9.692 , 47.726 , 54.72 , 9.832 , 48.696 , 54.06 , 11.192 , 47.166 , 51.96 , 11.552 , 
                                47.856 , 51.72 , 10.922 , 44.796 , 53.77 , 12.432 , 43.966 , 53.66 , 11.532 , 44.416 , 53.82 , 13.712 , 45.126 , 54.01 , 14.392 , 43.006 , 53.7 , 14.022 , 42.446 , 54.16 , 13.202 , 42.836 , 54.28 , 14.932 , 42.426 , 52.33 , 14.352 , 41.296 , 52.32 , 14.832 , 41.812 , 43.328 , 31.445 , 40.942 , 43.408 , 31.965 , 41.872 , 43.958 , 30.145 , 42.622 , 43.518 , 29.475 , 40.502 , 43.788 , 29.495 , 40.522 , 44.468 , 28.635 , 39.782 , 44.078 , 30.255 , 40.262 , 42.328 , 29.115 , 41.012 , 41.968 , 28.405 , 39.382 , 42.428 , 28.475 , 39.802 , 41.358 , 30.195 , 40.562 , 40.458 , 30.525 , 38.572 , 41.418 , 30.715 , 37.972 , 42.228 , 30.615 , 38.282 , 40.758 , 31.425 , 42.172 , 45.448 , 30.205 , 41.522 , 46.178 , 30.935 , 43.042 , 45.848 , 29.265 , 43.462 , 45.128 , 28.695 , 43.272 , 47.208 , 28.825 , 42.352 , 47.748 , 29.045 , 44.382 , 47.988 , 29.535 , 44.272 , 49.038 , 29.295 , 44.192 , 47.978 , 31.045 , 43.162 , 48.258 , 31.255 , 44.342 , 46.938 , 31.355 , 44.922 , 48.698 , 31.425 , 45.752 , 47.498 , 29.075 , 45.832 , 47.558 , 27.985 , 45.832 , 46.428 , 29.285 , 46.892 , 48.328 , 29.655 , 46.852 , 49.378 , 29.375 , 46.762 , 48.318 , 30.735 , 47.862 , 47.928 , 29.355 , 43.312 , 47.498 , 27.335 , 43.352 , 46.538 , 26.565 , 43.282 , 48.778 , 26.945 , 43.232 , 49.528 , 27.615 , 43.142 , 49.178 , 25.555 , 43.302 , 48.328 , 24.885 , 41.792 , 49.788 , 25.225 , 41.722 , 50.228 , 24.235 , 41.702 , 50.698 , 25.825 , 40.582 , 48.918 , 25.495 , 39.682 , 49.298 , 26.495 , 39.842 , 50.188 , 27.075 , 38.632 , 48.438 , 26.845 , 37.962 , 48.678 , 27.655 , 38.492 , 47.228 , 26.155 , 37.732 , 46.528 , 26.475 , 39.362 , 46.808 , 25.155 , 39.292 , 45.798 , 24.775 , 40.442 , 47.658 , 24.885 , 41.262 , 47.398 , 24.235 , 44.322 , 50.098 , 25.245 , 44.822 , 50.838 , 26.085 , 44.842 , 50.068 , 24.015 , 44.522 , 49.358 , 23.365 , 45.942 , 50.878 , 23.545 , 46.152 , 51.648 , 24.285 , 47.272 , 50.128 , 23.385 , 47.142 , 49.308 , 22.685 , 48.312 , 51.128 , 22.895 , 48.062 , 52.048 , 23.425 , 49.302 , 50.788 , 23.195 , 48.332 , 51.288 , 21.815 , 47.672 , 49.438 , 24.685 , 47.052 , 48.558 , 24.835 , 48.672 , 48.988 , 24.725 , 47.592 , 50.148 , 25.505 , 45.592 , 51.418 , 22.165 , 45.352 , 50.598 , 21.285 , 45.462 , 52.738 , 22.015 , 45.682 , 53.308 , 22.825 , 45.132 , 53.448 , 20.795 , 44.512 , 52.798 , 20.185 , 44.202 , 54.608 , 21.135 , 44.692 , 55.418 , 21.685 , 43.422 , 54.188 , 21.775 , 43.612 , 55.248 , 19.885 , 43.352 , 54.538 , 19.105 , 44.462 , 55.768 , 19.425 , 42.422 , 56.188 , 20.085 , 42.392 , 56.898 , 19.265 , 42.582 , 56.838 , 20.945 , 41.122 , 55.428 , 20.325 , 41.302 , 54.848 , 21.235 , 40.872 , 54.688 , 19.575 , 40.032 , 56.368 , 20.635 , 40.222 , 56.908 , 21.475 , 39.782 , 56.888 , 19.805 , 39.202 , 55.878 , 20.915 , 46.412 , 53.808 , 20.055 , 47.142 , 54.658 , 20.575 , 46.702 , 53.258 , 18.875 , 46.162 , 52.428 , 18.655 , 47.732 , 53.668 , 17.945 , 48.642 , 53.558 , 18.525 , 47.812 , 52.768 , 16.715 , 48.632 , 53.038 , 16.045 , 47.942 , 51.258 , 16.905 , 48.852 , 51.108 , 17.485 , 47.122 , 50.728 , 17.385 , 48.092 , 50.928 , 15.875 , 46.582 , 52.758 , 16.035 , 45.882 , 52.378 , 16.575 , 47.622 , 55.108 , 17.455 , 46.602 , 55.748 , 17.695 , 48.672 , 55.628 , 16.825 , 49.442 , 54.978 , 16.775 , 48.792 , 56.978 , 16.285 , 48.702 , 57.658 , 17.135 , 50.222 , 57.058 , 15.765 , 50.422 , 56.258 , 15.055 , 50.912 , 56.948 , 16.605 , 50.462 , 58.418 , 15.105 , 49.922 , 59.188 , 15.655 , 51.962 , 58.698 , 15.215 , 52.232 , 59.608 , 14.685 , 52.142 , 58.728 , 16.295 , 52.572 , 57.908 , 14.775 , 50.082 , 58.408 , 13.635 , 49.012 , 58.268 , 13.465 , 50.362 , 59.398 , 13.245 , 50.622 , 57.748 , 12.955 , 47.682 , 57.298 , 15.285 , 47.132 , 58.398 , 15.255 , 47.322 , 56.398 , 14.375 , 47.702 , 55.468 , 14.465 , 46.222 , 56.528 , 13.445 , 46.182 , 57.578 , 13.155 , 46.392 , 55.568 , 12.275 , 45.522 , 55.538 , 11.625 , 47.572 , 55.938 , 11.385 , 47.432 , 56.968 , 11.055 , 48.552 , 55.798 , 11.855 , 47.482 , 55.418 , 10.435 , 46.542 , 54.208 , 12.625 , 47.352 , 54.148 , 13.135 , 44.882 , 56.248 , 14.115 , 43.912 , 56.088 , 13.365 , 44.762 , 56.048 , 15.425 , 45.652 , 55.898 , 15.885 , 43.532 , 56.148 , 16.185 , 42.892 , 56.828 , 15.625 , 43.792 , 56.578 , 17.155 , 42.792 , 54.848 , 16.455 , 41.692 , 54.898 , 17.015]
    
    def test_prody_vs_lite_reading_differences(self):
        """
        This illustrates the reading differences between prody and lite reader. Prody will not read unknown residues, while
        the lite reader, as its simpler, will read everything. This makes the read coordinates different, and then the RMSD results.
        """
        prody_reader = Reader("PRODY_READER").readThisFile('data/amber_short.pdb').gettingOnlyCAs()
        prody_coordinates = prody_reader.read() 
        self.assertEqual(prody_reader.numberOfAtoms,66)
        lite_reader = Reader("LITE_READER").readThisFile('data/amber_short.pdb').gettingOnlyCAs()
        lite_coordinates = lite_reader.read()
        self.assertEqual(lite_reader.numberOfAtoms,76)
        self.assertNotEqual(prody_coordinates, lite_coordinates)
    
    def test_read_one(self):
        for reader_type in Reader.availableReaderTypes():
            reader = Reader(reader_type).readThisFile('data/amber_mini.pdb')
            coordinates = reader.read() 
            self.assertEqual(148, reader.numberOfAtoms)
            self.assertEqual(3, reader.numberOfFrames)
            numpy.testing.assert_almost_equal(self.mini_all_coords, flattenCoords(coordinates),12,"Failed with "+reader_type)
    
    def test_read_multiple(self):
        for reader_type in Reader.availableReaderTypes():
            reader = Reader(reader_type).readThisFile('data/amber_mini.pdb').andThisOtherFile('data/amber_mini.pdb')
            coordinates = reader.read()
            self.assertEqual(148, reader.numberOfAtoms)
            self.assertEqual(6, reader.numberOfFrames)
            self.assertEqual(len(flattenCoords(coordinates)),148*6*3)
            numpy.testing.assert_almost_equal(self.mini_all_coords, flattenCoords(coordinates)[0:148*3*3], 10, "Failed with "+reader_type)
            numpy.testing.assert_almost_equal(self.mini_all_coords, flattenCoords(coordinates)[148*3*3:], 10, "Failed with "+reader_type)
    
    def test_read_one_only_CA(self):
        for reader_type in Reader.availableReaderTypes():
            reader = Reader(reader_type).readThisFile('data/amber_mini.pdb').gettingOnlyCAs()
            coordinates = reader.read() 
            self.assertEqual(9, reader.numberOfAtoms)
            self.assertEqual(3, reader.numberOfFrames)
            numpy.testing.assert_almost_equal(self.mini_CA_coords, flattenCoords(coordinates), 10)     
    
    def test_read_multiple_only_CA(self):
        for reader_type in Reader.availableReaderTypes():
            reader = Reader(reader_type).readThisFile('data/amber_mini.pdb').andThisOtherFile('data/amber_mini.pdb').gettingOnlyCAs()
            coordinates = reader.read()
            self.assertEqual(9, reader.numberOfAtoms)
            self.assertEqual(6, reader.numberOfFrames)
            self.assertEqual(len(flattenCoords(coordinates)),9*6*3)
            numpy.testing.assert_almost_equal(self.mini_CA_coords, flattenCoords(coordinates)[0:9*3*3], 10, "Failed with "+reader_type)
            numpy.testing.assert_almost_equal(self.mini_CA_coords, flattenCoords(coordinates)[9*3*3:], 10, "Failed with "+reader_type)
        
if __name__ == "__main__":
    #import sys;sys.argv = ['', 'Test.testName']
    unittest.main()